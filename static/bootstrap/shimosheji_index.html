{% extends "shimosheji_base_admin.html" %}
{% block head %}
<title>石墨设计</title>
<style type="text/css">
.rgnav {
    display: none;
}
</style>
<script type="text/javascript"> require(['md5']); </script>
<script type="text/javascript">
require(['jquery','domReady!'], function(doc){
    if('{{p_email}}'!='None'){
        $('#signin_email').val('{{p_email}}');
    }
    if('{{p_passwd}}'!='None'){
        $('#signin_passwd').val('{{p_passwd}}');
    }
    $('#signup_btn').click(function() { 
        $('#signup_email').attr('disabled',false);
        $('#signup_passwd').attr('disabled',false);
        $('#signup_passwd2').attr('disabled',false);
        $('#signup_submit').attr('disabled',false);
        $('#signup_submit').text('注册');
        $('#signup_email').val('');
        $('#signup_passwd').val('');
        $('#signup_passwd2').val('');
        $('#signup_modal').modal('toggle');
    });
    $('#signin_form').submit(function() { 
        $('#signin_email').val($.trim($('#signin_email').val()).toLowerCase());
        $('#signin_email').val($('#signin_email').val().replace('﹫', '@'));
        $('#signin_email').val($('#signin_email').val().replace('。', '.'));
        var signin_email= $('#signin_email').val();
        var signin_passwd = $('#signin_passwd').val();
        if(signin_email.length <= 0 || signin_passwd.length <=0){
            $('#signin_msg').text('邮箱和密码不能为空');
            return false;
        }
        var emailPat =  /^([a-zA-Z0-9_-]|\.)+@([a-zA-Z0-9_-])+((\.[a-zA-Z0-9_-]{2,3}){1,2})$/;
        var matchArray = signin_email.match(emailPat);
        if(matchArray==null){
            $('#signin_msg').text('邮箱格式有误');
            return false;
        }
        var signin_s_passwd = hex_hmac_md5('{{p_pwsecret}}',signin_passwd);
        $('#signin_s_passwd').attr('value',signin_s_passwd);
        var options = { 
            url:'{{p_url["api_signin"]}}',
            type:'POST', 
            dataType: 'json',
            success: function(data){
                if( data.op==true){
                    $('#signin_submit').text('登录成功');
                    var next='{{p_next}}';
                    if( next=='None' ){
                        next='{{p_url["host_home"]}}';
                    }
                    location.href = decodeURIComponent(next);
                }else{
                    $('#signin_msg').text(data.msg);
                    $('#signin_submit').text('登 录');
                    $('#signin_submit').attr('disabled',false);
                    $('#signin_email').attr('disabled',false);
                    $('#signin_passwd').attr('disabled',false);
                    $('#signin_passwd2').attr('disabled',false);
                }
            },
            error: function(){
                $('#signin_msg').text('p_msg["err_500"]');
                $('#signin_submit').text('登 录');
                $('#signin_submit').attr('disabled',false);
                $('#signin_email').attr('disabled',false);
                $('#signin_passwd').attr('disabled',false);
                $('#signin_passwd2').attr('disabled',false);
            },
            beforeSubmit: function(formData, jqForm, options){
                $('#signin_msg').text('');
                $('#signin_submit').text('正在登录...');
                $('#signin_submit').attr('disabled',true);
                $('#signin_email').attr('disabled',true);
                $('#signin_passwd').attr('disabled',true);
                $('#signin_passwd2').attr('disabled',true);
            },
        }; 
        $('#signin_form').ajaxSubmit(options); 
        return false;
    });
    $('#signup_form').submit(function() { 
        $('#signup_email').val($.trim($('#signup_email').val()).toLowerCase());
        $('#signup_email').val($('#signup_email').val().replace('﹫', '@'));
        $('#signup_email').val($('#signup_email').val().replace('。', '.'));
        var signup_email= $('#signup_email').val();
        var signup_passwd = $('#signup_passwd').val();
        var signup_passwd2 = $('#signup_passwd2').val();
        if(signup_email.length <= 0){
            $('#signup_msg').text('邮箱不能为空');
            return false;
        }
        var emailPat =  /^([a-zA-Z0-9_-]|\.)+@([a-zA-Z0-9_-])+((\.[a-zA-Z0-9_-]{2,3}){1,2})$/;
        var matchArray = signup_email.match(emailPat);
        if(matchArray==null){
            $('#signup_msg').text('邮箱格式有误');
            return false;
        }
        if(signup_passwd.length < 6 || signup_passwd.length > 20){
            $('#signup_msg').text('请用6-20位字母或数字作为密码');
            return false;
        }
        if(signup_passwd!=signup_passwd2){
            $('#signup_msg').text('两次密码不相同');
            return false;
        }
        var signup_s_passwd = hex_hmac_md5('{{p_pwsecret}}',signup_passwd);
        $('#signup_s_passwd').attr('value',signup_s_passwd);
        var options = { 
            url:'{{p_url["api_signup"]}}',
            type:'POST', 
            dataType: 'json',
            success: function(data){
                $('#signup_msg').text(data.msg);
                if( data.op==true){
                    $('#signup_submit').text('注册成功');
                    $('#signup_submit').attr('disabled',true);
                    $('#signup_email').attr('disabled',true);
                    $('#signup_passwd').attr('disabled',true);
                    $('#signup_passwd2').attr('disabled',true);
                    var timer_hide = setTimeout(function() {
                            $('#signin_email').val(signup_email);
                            $('#signup_modal').modal('hide');
                            $("#signin_passwd").focus();
                        }, 1000);
                }else{
                    $('#signup_submit').text('注册');
                    $('#signup_submit').attr('disabled',false);
                }
            },
            error: function(){
                $('#signup_submit').text('注册');
                $('#signup_submit').attr('disabled',false);
                $('#signup_msg').text('p_msg["err_500"]');
            },
            beforeSubmit: function(formData, jqForm, options){
                $('#signup_submit').attr('disabled',true);
                $('#signup_submit').text('正在注册...');
                $('#signup_msg').text('正在注册...');
            },
        }; 
        $('#signup_form').ajaxSubmit(options); 
        return false;
    });
});
</script>
{% end %}

{% block location %}
{% end %}

{% block header %}
{% end %}

{% block body %}
<!-- Modal -->
<div id="signup_modal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
        <h4>注册一个账号</h4>
    </div>
    <div class="rgsignup modal-body">
        <form id="signup_form" >
            {% raw xsrf_form_html() %}
            <label class="text-error rglabel" id="signup_msg">&nbsp</label>
            <div class="input-prepend" style="margin-bottom:10px;">
                <span class="add-on"><i class="icon-user"></i></span>
                <input type="text" id="signup_email"  class="rginput" name="email" placeholder="邮箱">
            </div>
            <div class="input-prepend" style="margin-bottom:10px;">
                <span class="add-on"><i class="icon-lock"></i></span>
                <input type="password" id="signup_passwd"  class="rginput" placeholder="密码">
            </div>
            <div class="input-prepend" style="margin-bottom:10px;">
                <span class="add-on"><i class="icon-arrow-up"></i></span>
                <input type="password" id="signup_passwd2" class="rginput" placeholder="再次输入密码">
            </div>
            <input type="text" id="signup_s_passwd"  class="hidden" name="passwd"  value="">
            <button type="submit"  id="signup_submit"  class="rgbtn">注 册</button>
        </form>
    </div>
    <div class="modal-footer hidden">
    </div>
</div>
<div class="rgbase">
    <div class="row-fluid rgindex" >
        <div class="span7 row-fluid" style="padding-top:80px;">
            <div class="span3 offset2">
                <a class="pull-right" href="{{p_url['guest_main']}}"><img class="pull-left" style="width:110px;height:110px;" src="/img/shimosheji/logo_110.png"></a>
            </div>
            <div class="span5 text-center" >
                <h2 style="line-height:50px;">羴羴 &middot; 石墨设计</h2>
                <h5 class="muted" style="line-height:40px;font-family:'微软雅黑';">对&nbsp;面&nbsp;的&nbsp;兔&nbsp;纸&nbsp;看&nbsp;过&nbsp;来&nbsp;</h5>
            </div>
        </div>
        <div class="span5" style="padding-bottom:40px;">
            <div style="margin:60px 0px 0px 5px;">
                <h4 style="font-family:'微软雅黑';margin-bottom:10px;"><strong>亲爱的管理员您好!</strong></h4>
                <label class="muted rglabel">任何与网站有关的建议，欢迎联系：</label>
                <label class="muted rglabel">羴羴：QQ - 948059759</label>
                <label class="muted rglabel">单核：QQ - 85938022</label>
                <br/>
                <p class="">这一切因您的经营而<strong class="rglink rgfont16"> 精彩</strong></p>
            </div>
            <br/>
        </div>
    </div>
    <form class="rgopbar" id="signin_form">
        {% raw xsrf_form_html() %}
        <div class="row-fluid" >
            <div class="span3 offset2" style="height:20px;padding-top:5px;"><label class="rglabel text-error" id="signin_msg"></label></div>
            <div class="span3" style="height:20px;"> <input type="text" id="signin_s_passwd" class="hidden" name="passwd"  value=""></div>
        </div>
        {% if p_session == None %}
        <div class="row-fluid" >
            <div class="span3 offset2">
                <div class="input-prepend">
                    <span class="add-on" style="height:33px;background-color:#ffffff;border-radius: 2px 0 0 2px;"><img src="/img/sdk/user.gif" style="width:33px;height:33px;"></span>
                    <input style="width:188px;height:33px;border-radius: 0 2px 2px 0;border-left:0px;" type="text" id="signin_email" name="email" placeholder="邮箱">
                </div>
            </div>
            <div class="span3">
                <div class="input-prepend">
                    <span class="add-on" style="height:33px;background-color:#ffffff;border-radius: 2px 0 0 2px;"><img src="/img/sdk/passwd.gif" style="width:33px;height:33px;"></span>
                    <input style="width:188px;height:33px;border-radius: 0 2px 2px 0;border-left:0px;" type="password" id="signin_passwd" placeholder="密码">
                </div>
            </div>
            <div class="span2"> <button type="submit" id="signin_submit" class="rgbtn">登 录</button> </div>
            <div class="span2"> <a id="signup_btn" class="rglink btn-link" href="javascript:void(0)" style="line-height:42px;font-size:14px;">注册</a> </div>
        </div>
        <div class="row-fluid" >
            <div class="span3 offset2">
                <input id="rememberme" style="margin-bottom:5px;" type="checkbox" name="rememberme" value="on">
                <span class="rglink rgfont12">自动登录</span>
            </div>
            <div class="span3"> <a href="{{p_url['guest_findpwd']}}" class="rglink btn-link rgfont12">忘记密码</a> </div>
        </div>
        {% else %}
        <div class="row-fluid" >
            <div class="span7 offset2" style="color:#ffffff;"><label class="rglabel pull-right">{{p_session['email']}}</label></div>
            <div class="span1"> <a class="rglink btn-link pull-right" href="{{p_url['host_home']}}">进入管理</a> </div>
            <div class="span1"> <a class="rglink btn-link pull-right" href="{{p_url['guest_signout']}}">切换账号</a> </div>
        </div>
        {% end %}
    </form>
</div> <!-- /rgbase-->
<!-- Le javascript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
{% end %}

{% block footer %}
{% end %}

